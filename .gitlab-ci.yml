# ============================================================================
# Tree Navigator - Complete GitLab CI/CD Pipeline
# This is the SINGLE, COMPLETE CI/CD configuration
# ============================================================================

stages:
  - lint
  - build
  - test
  - security
  - performance
  - package
  - deploy
  - monitoring

variables:
  GNAT_VERSION: "13"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  GIT_DEPTH: 0

# ============================================================================
# Templates & Reusable Configurations
# ============================================================================

.gnat_base:
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq gnat-${GNAT_VERSION} gprbuild make file git
    - gnat --version
    - gprbuild --version

.docker_base:
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info

.just_base:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget gnat-${GNAT_VERSION} gprbuild
    - wget https://github.com/casey/just/releases/download/1.21.0/just-1.21.0-x86_64-unknown-linux-musl.tar.gz
    - tar xzf just-1.21.0-x86_64-unknown-linux-musl.tar.gz
    - mv just /usr/local/bin/
    - just --version

.cache_template:
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - obj/
      - .cache/

# ============================================================================
# LINT STAGE - Code Quality
# ============================================================================

lint:syntax:
  extends: [.gnat_base, .cache_template]
  stage: lint
  script:
    - echo "üîç Checking Ada syntax..."
    - |
      for file in src/*.ad[sb]; do
        echo "Checking $file..."
        gcc -c -gnat2022 -gnats "$file" || exit 1
      done
    - echo "‚úÖ Syntax check passed"
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    when: always
    expire_in: 1 week

lint:formatting:
  extends: .gnat_base
  stage: lint
  script:
    - echo "üîç Checking code formatting..."
    - |
      if find src -name "*.ad[sb]" -exec grep -l $'\t' {} \; > tabs.txt && [ -s tabs.txt ]; then
        echo "‚ùå Files with tabs found:"
        cat tabs.txt
        exit 1
      fi
    - |
      if find src -name "*.ad[sb]" -exec file {} \; | grep CRLF; then
        echo "‚ùå CRLF line endings found"
        exit 1
      fi
    - echo "‚úÖ Formatting check passed"
  allow_failure: false

# ============================================================================
# BUILD STAGE - Multiple Configurations
# ============================================================================

build:debug:
  extends: [.gnat_base, .cache_template]
  stage: build
  script:
    - echo "üî® Building debug version..."
    - gprbuild -P tree_navigator.gpr -j0
    - ls -lah bin/
    - ./bin/main --version
    - echo "‚úÖ Debug build complete"
  artifacts:
    name: "tree-navigator-debug-${CI_COMMIT_SHORT_SHA}"
    paths:
      - bin/main
      - obj/
    expire_in: 1 day
  needs: []

build:release:
  extends: [.gnat_base, .cache_template]
  stage: build
  script:
    - echo "üî® Building release version..."
    - gprbuild -P tree_navigator.gpr -XBuild_Mode=release -j0
    - strip bin/main
    - ls -lah bin/
    - ./bin/main --version
    - echo "‚úÖ Release build complete"
  artifacts:
    name: "tree-navigator-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - bin/main
    expire_in: 30 days
  needs: []
  only:
    - main
    - tags
    - merge_requests

# ============================================================================
# TEST STAGE - Comprehensive Testing
# ============================================================================

test:functional:
  extends: .gnat_base
  stage: test
  dependencies:
    - build:debug
  script:
    - echo "üß™ Running functional tests..."
    - mkdir -p test_project/{src,obj,bin,docs}
    - touch test_project/src/{main.adb,config.ads,utils.adb}
    - echo "#!/bin/bash" > test_project/build.sh
    - chmod +x test_project/build.sh
    
    - ./bin/main --export test1.txt --dir test_project
    - ./bin/main --export test2.txt --dir test_project --max-depth 1
    - ./bin/main --export test3.txt --dir test_project --exclude-dirs obj,bin
    - ./bin/main --export test4.txt --dir test_project --show-size
    
    - echo "‚úÖ All functional tests passed"
  artifacts:
    paths:
      - test*.txt
    when: always
    expire_in: 1 week

test:coverage:
  extends: .gnat_base
  stage: test
  dependencies:
    - build:debug
  script:
    - echo "üìä Generating coverage report..."
    - apt-get install -y -qq gcovr
    - ./bin/main --export coverage-test.txt --max-depth 3
    - echo "‚úÖ Coverage report generated"
  coverage: '/lines: \d+\.\d+%/'
  artifacts:
    paths:
      - coverage.html
    expire_in: 30 days
  only:
    - main
    - merge_requests

# ============================================================================
# SECURITY STAGE - Vulnerability Scanning
# ============================================================================

security:container:
  extends: .docker_base
  stage: security
  dependencies:
    - build:release
  script:
    - echo "üîí Scanning container for vulnerabilities..."
    - docker build -t tree-navigator:${CI_COMMIT_SHORT_SHA} .
    - |
      docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy image --severity HIGH,CRITICAL \
        tree-navigator:${CI_COMMIT_SHORT_SHA} || true
    - echo "‚úÖ Container scan complete"
  allow_failure: true
  only:
    - main
    - merge_requests

# ============================================================================
# PERFORMANCE STAGE - Benchmarking
# ============================================================================

performance:benchmark:
  extends: .gnat_base
  stage: performance
  dependencies:
    - build:release
  script:
    - echo "‚ö° Running performance benchmarks..."
    - apt-get install -y -qq time bc
    - mkdir -p perf_test
    - for i in {1..100}; do mkdir -p perf_test/dir_$i; for j in {1..50}; do echo "content" > perf_test/dir_$i/file_$j.txt; done; done
    - /usr/bin/time -v ./bin/main --export perf.txt --dir perf_test 2>&1 | tee benchmark.txt
    - echo "‚úÖ Benchmark complete"
  artifacts:
    paths:
      - benchmark.txt
    expire_in: 30 days
  only:
    - main
    - tags

# ============================================================================
# PACKAGE STAGE - Build All Distribution Packages
# ============================================================================

package:deb:
  extends: .gnat_base
  stage: package
  dependencies:
    - build:release
  script:
    - echo "üì¶ Creating DEB package..."
    - apt-get install -y -qq dpkg-dev debhelper
    - VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
    
    - mkdir -p package/DEBIAN
    - mkdir -p package/usr/local/bin
    - mkdir -p package/usr/local/share/man/man1
    - mkdir -p package/usr/share/doc/tree-navigator
    
    - cp bin/main package/usr/local/bin/tree-navigator
    - cp man/tree-navigator.1 package/usr/local/share/man/man1/
    - cp README.md LICENSE CHANGELOG.md package/usr/share/doc/tree-navigator/
    
    - |
      cat > package/DEBIAN/control << CTRL
      Package: tree-navigator
      Version: ${VERSION}
      Section: utils
      Priority: optional
      Architecture: amd64
      Maintainer: Tree Navigator Contributors <team@tree-navigator.io>
      Description: Type-safe directory tree visualization tool
       A powerful directory tree export and navigation tool with
       extensive filtering capabilities, built with Ada 2022.
      CTRL
    
    - dpkg-deb --build package tree-navigator_${VERSION}_amd64.deb
    - echo "‚úÖ DEB package created"
  artifacts:
    name: "tree-navigator-deb-${CI_COMMIT_REF_NAME}"
    paths:
      - tree-navigator_*.deb
    expire_in: 90 days
  only:
    - main
    - tags

package:rpm:
  extends: .gnat_base
  stage: package
  dependencies:
    - build:release
  script:
    - echo "üì¶ Creating RPM package..."
    - apt-get install -y -qq rpm
    - VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
    - mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
    - cp packaging/fedora/tree-navigator.spec ~/rpmbuild/SPECS/
    - rpmbuild -bb ~/rpmbuild/SPECS/tree-navigator.spec || echo "‚ö†Ô∏è  RPM build had issues"
    - cp ~/rpmbuild/RPMS/x86_64/*.rpm . || true
    - echo "‚úÖ RPM package created"
  artifacts:
    name: "tree-navigator-rpm-${CI_COMMIT_REF_NAME}"
    paths:
      - "*.rpm"
    expire_in: 90 days
  only:
    - main
    - tags
  allow_failure: true

package:tarball:
  extends: .gnat_base
  stage: package
  dependencies:
    - build:release
  script:
    - echo "üì¶ Creating source tarball..."
    - VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
    - mkdir -p tree-navigator-${VERSION}
    - cp bin/main tree-navigator-${VERSION}/tree-navigator
    - cp README.md LICENSE CHANGELOG.md CONTRIBUTING.md tree-navigator-${VERSION}/
    - cp -r man tree-navigator-${VERSION}/
    - tar czf tree-navigator-${VERSION}-linux-x86_64.tar.gz tree-navigator-${VERSION}
    - tar czf tree-navigator-${VERSION}-source.tar.gz --exclude=obj --exclude=bin --exclude=.git .
    - sha256sum tree-navigator-*.tar.gz > SHA256SUMS
    - echo "‚úÖ Tarballs created"
  artifacts:
    name: "tree-navigator-tarball-${CI_COMMIT_REF_NAME}"
    paths:
      - tree-navigator-*.tar.gz
      - SHA256SUMS
    expire_in: 90 days
  only:
    - main
    - tags

package:docker:
  extends: .docker_base
  stage: package
  dependencies:
    - build:release
  script:
    - echo "üê≥ Building Docker image..."
    - docker build -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} .
    - docker build -t ${CI_REGISTRY_IMAGE}:latest .
    - docker tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}
    - echo ${CI_REGISTRY_PASSWORD} | docker login -u ${CI_REGISTRY_USER} --password-stdin ${CI_REGISTRY}
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}
    - |
      if [ "${CI_COMMIT_BRANCH}" == "main" ]; then
        docker push ${CI_REGISTRY_IMAGE}:latest
      fi
    - echo "‚úÖ Docker image pushed"
  only:
    - main
    - tags
    - merge_requests

# ============================================================================
# DEPLOY STAGE - Release Creation and Distribution
# ============================================================================

release:gitlab:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - package:deb
    - package:rpm
    - package:tarball
  script:
    - echo "üöÄ Creating GitLab release..."
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'Tree Navigator $CI_COMMIT_TAG'
    description: |
      ## Tree Navigator $CI_COMMIT_TAG
      
      Type-safe directory tree visualization tool built with Ada 2022.
      
      ### üöÄ Quick Install
      
      **Debian/Ubuntu:**
```bash
      wget https://gitlab.com/hyperpolymath/tree-navigator/-/package_files/${CI_JOB_ID}/download -O tree-navigator.deb
      sudo dpkg -i tree-navigator.deb
```
      
      **Fedora/RHEL:**
```bash
      sudo dnf install https://gitlab.com/hyperpolymath/tree-navigator/-/package_files/${CI_JOB_ID}/download
```
      
      **From Tarball:**
```bash
      wget https://gitlab.com/hyperpolymath/tree-navigator/-/archive/$CI_COMMIT_TAG/tree-navigator-$CI_COMMIT_TAG.tar.gz
      tar xzf tree-navigator-$CI_COMMIT_TAG.tar.gz
      cd tree-navigator-*
      gprbuild -P tree_navigator.gpr -XBuild_Mode=release
      sudo cp bin/main /usr/local/bin/tn
```
      
      ### üìù Changes
      
      See [CHANGELOG.md](https://gitlab.com/hyperpolymath/tree-navigator/-/blob/main/CHANGELOG.md)
  only:
    - tags

# ============================================================================
# MONITORING STAGE - Post-Deployment Checks
# ============================================================================

monitoring:smoke_test:
  extends: .gnat_base
  stage: monitoring
  dependencies:
    - package:tarball
  script:
    - echo "üí® Running smoke tests..."
    - tar xzf tree-navigator-*-linux-x86_64.tar.gz
    - cd tree-navigator-*
    - ./tree-navigator --version
    - ./tree-navigator --help
    - echo "‚úÖ Smoke tests passed"
  needs:
    - package:tarball
  only:
    - main
    - tags

# ============================================================================
# WORKFLOW RULES
# ============================================================================

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - when: never
